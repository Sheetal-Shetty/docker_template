apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: Baremetal-deploy-from-Ansible
  title: Deploy application from Ansible
  description: Baremetal deployment of application from Ansible
spec:
  owner: user:guest
  type: service

  
  parameters:
    - title: GitHub Repository URL
      required: 
        - Github_URL
        #- Dockerfile
        #- Port
      properties:
        Github_URL:
          title: Enter you Github URL
          type: string
          description: Enter the github URL where your code exists
          ui:autofocus: true

    - title: Select where you want to deploy your code
      required:
        - stack
      properties:
        stack:
          title: Select from below list
          type: string
          enum:
            - Docker
            - Github pages
            - Baremetal
            - Kubernetes
  
    - title: Enter below details
      dependencies:
        stack:
          oneOf:
            - properties:
                stack:
                  const: Docker
                extraFields:          # ðŸ‘ˆ wrap everything else inside a schema key
                  title: Enter the details
                  type: object
                  properties:
                    WebPath:
                      title: Enter the Path of web docker file
                      type: string
                      description: Enter the PlaybookPath
                      default: "mompopcafe/Dockerfile" 
                    DBPath:
                      title: Enter the Path of db docker file
                      type: string
                      description: Enter the PlaybookPath
                      default: "mompopdb/Dockerfile" 
                    Port:
                      title: Enter the Port number
                      type: integer
                      minimum: 1
                      maximum: 65535
                      description: Enter the Port number of your application (e.g. 80/3000/5000)
  
            - properties:
                stack:
                  const: Github pages
                extraFields:
                  type: object
                  properties: {}
  
            - properties:
                stack:
                  const: Kubernetes
                extraFields:
                  type: object
                  properties: {}
  
            - properties:
                stack:
                  const: Baremetal
                extraFields:
                  type: object
                  properties: {}
            

          
  steps:
    - id: fetch-template
      name: Fetch template files
      action: fetch:plain
      input:
        url: ${{ parameters.Github_URL }}
        targetPath: .
    - id: delete_network
      name: delete_network
      if: ${{ parameters.stack == 'Docker' }}
      action: shell:run
      input:
        cwd: ${{ steps.fetch-template.output.path }}
        command: docker 
        args: ["network", "rm", "new-network"]
 
    - id: Create_network
      name: Create_network
      if: ${{ parameters.stack == 'Docker' }}
      action: shell:run
      input:
        cwd: ${{ steps.fetch-template.output.path }}
        command: docker 
        args: ["network", "create", "new-network"]

   

    - id: build_docker_1
      name: build_docker_1
      if: ${{ parameters.stack == 'Docker' }}
      action: shell:run
      input:
        cwd: ${{ steps.fetch-template.output.path }}
        command: docker 
        args: ["build", "-f", "${{ parameters.extraFields.WebPath }}", "-t", "new-image:latest", "."]

    - id: cleanup_1
      name: cleanup_1
      if: ${{ parameters.stack == 'Docker' }}
      action: shell:run
      input:
        command: docker
        args: ["rm", "-f", "Cafe-container"]
        
    - id: build_docker_db
      name: build_docker_db
      if: ${{ parameters.stack == 'Docker' }}
      action: shell:run
      input:
        cwd: "${{ steps.fetch-template.output.path }}/mompopdb"
        command: docker 
        args: ["build", "-f", "${{ parameters.extraFields.DBPath }}", "-t", "new-db-image:latest", "."]


    - id: cleanup_2
      name: cleanup_2
      if: ${{ parameters.stack == 'Docker' }}
      action: shell:run
      input:
        command: docker
        args: ["rm", "-f", "DB-container"]
                

    - id: deploy_docker_1
      name: deploy_docker_1
      if: ${{ parameters.stack == 'Docker' }}
      action: shell:run
      input:
        cwd: ${{ steps.fetch-template.output.path }}
        command: docker
        args: ["run", "--name", "Cafe-container", "--network", "new-network", "-it", "-d", "-p", "89:${{ parameters.extraFields.Port }}", "new-image:latest"]

    - id: deploy_docker_2
      name: deploy_docker_2
      if: ${{ parameters.stack == 'Docker' }}
      action: shell:run
      input:
        cwd: ${{ steps.fetch-template.output.path }}
        command: docker
        args: ["run", "--name", "DB-container", "--network", "new-network", "-it", "-d", "-p", "3307:3306", "new-db-image:latest"]

  
  output:
    links:
      - title: "Open Website"
        url: "http://localhost:89"
        icon: "website"
    # - id: fetch-template
    #   name: Fetch template files
    #   action: fetch:plain
    #   input:
    #     url: ${{ parameters.Github_URL }}
    #     targetPath: .
        
    # - id: fetch-repo
    #   name: Fetch GitHub Repository Archive
    #   action: fetch:plain
    #   input:
    #     url: https://github.com/Sheetal-Shetty/Cafe_Dynamic_Website/archive/refs/heads/main.zip
    #     targetPath: repo.zip
  
    # # Step 2: Unzip the repo
    # - id: unzip-repo
    #   name: Unzip Repository
    #   action: shell:run
    #   input:
    #     command: unzip
    #     args: ["repo.zip", "-d", "."]
  
    # # Step 3: Run Docker Compose
    # - id: run-docker-compose
    #   name: Run Docker Compose
    #   if: ${{ parameters.stack == 'Baremetal' }}
    #   action: shell:run
    #   input:
    #     cwd: ./Cafe_Dynamic_Website-main
    #     command: docker
    #     args: ["compose", "up", "--build"]


    # - id: unzip-repo
    #   name: Unzip Repository
    #   action: shell:run
    #   input:
    #     command: unzip
    #     args: ["repo.zip", "-d", "."]

    # # Step 3: Deploy containers via Docker Compose
    # - id: docker-compose-up
    #   name: Deploy Containers via Docker Compose
    #   action: shell:run
    #   input:
    #     cwd: ./$(basename ${{ parameters.Github_URL | replace('.git','') }})-main
    #     command: bash
    #     args:
    #       - -c
    #       - |
    #         set -e
    #         echo "Deploying application using Docker Compose..."
            
    #         if [ -f "${{ parameters.ComposeFile }}" ]; then
    #           echo "Stopping any existing containers..."
    #           docker-compose -f "${{ parameters.ComposeFile }}" down || true
              
    #           echo "Starting containers..."
    #           docker-compose -f "${{ parameters.ComposeFile }}" up -d
              
    #           echo "Containers started successfully!"
    #         else
    #           echo "Error: docker-compose.yml not found at '${{ parameters.ComposeFile }}'"
    #           exit 1
    #         fi

